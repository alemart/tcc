/*!
 * runtime engine
 * http://gamewizard.cc/
 * Copyright 2011, Alexandre Martins <alemartf(at)gmail(dot)com>
 */
soundlib={_ready:function(){},_timeout:function(){},html5Test:/^(probably|maybe)$/i};
soundlib.canPlayURL=function(a,d){var e=a.match(/\.[a-z0-9]+$/i);if(e!=null){var b=e[0].substr(1).toLowerCase(),f={mp3:['audio/mpeg; codecs="mp3"',"audio/mpeg","audio/mp3","audio/MPA","audio/mpa-robust"],mp4:['audio/mp4; codecs="mp4a.40.2"',"audio/aac","audio/x-m4a","audio/MP4A-LATM","audio/mpeg4-generic"],aac:['audio/mp4; codecs="mp4a.40.2"',"audio/aac","audio/x-m4a","audio/MP4A-LATM","audio/mpeg4-generic"],m4a:['audio/mp4; codecs="mp4a.40.2"',"audio/aac","audio/x-m4a","audio/MP4A-LATM","audio/mpeg4-generic"],
ogg:["audio/ogg; codecs=vorbis"],wav:['audio/wav; codecs="1"',"audio/wav","audio/wave","audio/x-wav"],webm:["audio/webm"],mid:["audio/mid"],rmi:["audio/rmi"]};if((d==void 0||d=="html5")&&f[b]!=void 0){var e=soundlib._createAudio(),b=f[b],g;for(g in b)if(e.canPlayType(b[g]).match(soundlib.html5Test)!=null)return!0}}return!1};soundlib._subclassResponsibility=function(){alert("Can't instantiate abstract class");return null};
soundlib._implements=function(a,d){return function(){var e=new a,b;for(b in e)this[b]=e[b];d.apply(this,arguments)}};soundlib._merge=function(a,d){var e={},b;for(b in a)a.hasOwnProperty(b)&&(e[b]=a[b]);if(d!=void 0)for(b in d)d.hasOwnProperty(b)&&(e[b]=d[b]);return e};soundlib._defaultSoundOptions={url:"",volume:0.5,timeout:1E4,ontimeout:function(){},onfinish:function(){},onstop:function(){},onpause:function(){},onplay:function(){},onresume:function(){},oncanplaythrough:function(){},onerror:function(){}};
soundlib._createAudio=function(){var a=null;try{a=new Audio}catch(d){try{a=new Audio(null)}catch(e){try{a=document.createElement("audio")}catch(b){throw Error("Can't create HTML5 Audio object: "+d.message+","+e.message+","+b.message);}}}return a};
soundlib.Sound=function(){this.destruct=function(){soundlib._subclassResponsibility()};this.clone=function(){return soundlib._subclassResponsibility()};this.play=function(){soundlib._subclassResponsibility()};this.stop=function(){soundlib._subclassResponsibility()};this.pause=function(){soundlib._subclassResponsibility()};this.resume=function(){soundlib._subclassResponsibility()};this.setVolume=function(){soundlib._subclassResponsibility()};this.getVolume=function(){return soundlib._subclassResponsibility()};
this.setPosition=function(){soundlib._subclassResponsibility()};this.getPosition=function(){return soundlib._subclassResponsibility()};this.getDuration=function(){return soundlib._subclassResponsibility()};this.isPlaying=function(){return soundlib._subclassResponsibility()}};
soundlib._SilentSound=soundlib._implements(soundlib.Sound,function(a){this.clone=function(){return new soundlib._SilentSound};this.destruct=function(){};this.play=function(){};this.stop=function(){};this.pause=function(){};this.resume=function(){};this.setVolume=function(){};this.getVolume=function(){return 0};this.setPosition=function(){};this.getPosition=function(){return 0};this.getDuration=function(){return 0};this.isPlaying=function(){return!1};a.oncanplaythrough()});
soundlib._HTML5Sound=soundlib._implements(soundlib.Sound,function(a,d){var e=this,b=0,f=!1,g=!1,h=!1,i=!1,c=null;d==void 0?(c=soundlib._createAudio(),c.volume=a.volume,c.addEventListener("error",function(c){a.onerror(c)},!1),c.addEventListener("canplaythrough",function(){if(!g&&(g=!0,!i))a.oncanplaythrough()},!1),c.addEventListener("ended",function(){b<=1?(h=!1,a.onfinish()):e.play(b-1)},!1),setTimeout(function(){i=!0;if(!g)a.ontimeout()},a.timeout),c.autoplay=!1,c.preload="auto",c.controls=!1,c.src=
a.url):(c=d,c.volume=a.volume,c.addEventListener("canplaythrough",function(){g=!0},!1),c.addEventListener("ended",function(){b<=1?h=!1:e.play(b-1)},!1));this.destruct=function(){try{c.pause(),c.currentTime=0}catch(a){}f=h=!1;delete c};this.clone=function(){var b=soundlib._merge(soundlib._defaultSoundOptions,{url:a.url,volume:a.volume});return new soundlib._HTML5Sound(b,c.cloneNode(!0))};this.play=function(d){if(g)try{if(b=d==void 0?1:d,b>0)c.pause(),c.currentTime=0,c.play(),f=!1,h=!0,a.onplay()}catch(j){alert("soundlib._HTML5Audio.play error: "+
j.message)}else setTimeout(function(){e.play(d)},1E3)};this.stop=function(){try{c.pause(),c.currentTime=0,h=f=!1,a.onstop()}catch(b){}};this.pause=function(){try{c.pause(),f=!0,h=!1,a.onpause()}catch(b){}};this.resume=function(){try{f&&(c.play(),f=!1,h=!0,a.onresume())}catch(b){}};this.setVolume=function(a){try{c.volume=Math.max(0,Math.min(1,a))}catch(b){}};this.getVolume=function(){try{return c.volume}catch(a){return 1}};this.setPosition=function(a){try{c.currentTime=Math.max(0,Math.min(c.duration,
a))}catch(b){}};this.getPosition=function(){try{return c.currentTime}catch(a){return 0}};this.getDuration=function(){try{return c.duration}catch(a){return 0}};this.isPlaying=function(){return h}});soundlib.createSound=function(a){a=soundlib._merge(soundlib._defaultSoundOptions,a);return soundlib.canPlayURL(a.url,"html5")?new soundlib._HTML5Sound(a):new soundlib._SilentSound(a)};soundlib.onready=function(a){soundlib._ready=a};soundlib.ontimeout=function(a){soundlib._timeout=a};soundlib.init=function(){soundlib._ready()};
function LoadingScreen(){var b=$("#screen0").get(0),a=b.getContext("2d");this.display=function(e,c){c=Math.floor(100*Math.max(Math.min(1,c),0));b.style.visibility="visible";a.save();a.fillStyle="#2B3856";a.fillRect(0,0,b.width,b.height);a.fillStyle="#fff";a.font="36px sans-serif";a.textAlign="center";a.textBaseline="bottom";a.fillText("Now loading...",b.width/2,b.height/2);a.fillStyle="#000";a.fillRect(b.width/2-100,b.height/2+20,200,30);var d=a.createLinearGradient(0,b.height/2+21,0,b.height/2+51-
2);d.addColorStop(0,"#2b3856");d.addColorStop(1,"#5E5A80");a.fillStyle=d;a.fillRect(b.width/2-100+1,b.height/2+21,2*c-2,28);a.fillStyle="#fff";a.font="18px sans-serif";a.textAlign="center";a.textBaseline="bottom";a.fillText(c+"%",b.width/2,b.height/2+47);a.fillStyle="#fff";a.font="11px sans-serif";a.textAlign="right";a.textBaseline="bottom";a.fillText(e,b.width-5,b.height-5);a.restore()};this.clear=function(){a.clearRect(0,0,b.width,b.height)}};
function RAM(b){if(typeof b!="number"||b<=0)throw Error("Can't initialize the memory: invalid number of memory cells");var c=Array(b);this.reset=function(){for(var a=0;a<c.length;a++)c[a]=0};this.reset();this.read=function(a){if(a<0||a>=b)throw Error("memread: out of bounds error");return c[a]};this.write=function(a,d){if(a<0||a>=b)throw Error("memwrite: out of bounds error");return c[a]=d};this.capacity=function(){return b}};
function ImageData(){var b={};this.release=function(){for(var a in b)b[a]=null;b={}};this.load=function(a,e,f){b={};var g=a.length;(function(a){if(a.length>0){var h=arguments.callee,d=a.shift(),c=(""+d.id).toLowerCase(),d=d.url;e({file:c,total:g,remaining:1+a.length});b[c]=new Image;b[c].onabort=function(){throw Error("Can't load media '"+c+"': interrupted");};b[c].onerror=function(){throw Error("Can't load media '"+c+"': read error");};b[c].onload=function(){h(a)};b[c].src=d}else f()})(a)};this.get=
function(a){a=(""+a).toLowerCase();if(a in b)return b[a];else throw Error("Can't find media '"+a+"'");}};
function AudioData(){var h={},f=1,b={0:null},e=!1,i=function(a){$("#printer").text($("#printer").text()+"\n"+a)};this.release=function(){for(var a in b)b[a]!=null&&(b[a].destruct(),delete b[a]);f=1;b={0:null};h={}};this.load=function(a,b,f){var l=function(){var e=a.length;(function(a,c){if(a.length>0){var j=arguments.callee,d=a.shift(),g=(""+d.id).toLowerCase(),d=d.url;b({file:g,total:e,remaining:1+a.length});soundlib.canPlayURL(d)?h[g]=soundlib.createSound({url:d,timeout:5E3,ontimeout:function(){i("'"+
g+"' timed out!");j(a,c)},oncanplaythrough:function(){j(a,c)},onerror:function(){i("Error while loading media '"+g+"'")}}):(c.push(g),j(a,c))}else{if(c.length>0){for(var d="The following audio file"+(c.length>0?"s":"")+" cannot be played by this browser:",k=0;k<c.length;k++)d+="\n* "+c[k];i(d)}f()}})(a,[])};soundlib.html5Test=/^(probably|maybe)$/i;soundlib.onready(function(){e=!0;l()});soundlib.ontimeout(function(){e=!1;alert("Can't initialize audio.");f()});soundlib.init()};this.getVoice=function(a){a=
parseInt(a);return e&&a in b?b[a]:null};this.createVoice=function(a){if(e)if(a in h)return b[f]=h[a].clone(),f++;else throw Error("Can't create voice: media '"+a+"' doesn't exist!");return 0};this.destroyVoice=function(a){e&&a!=0&&a in voice&&(b[a].destruct(),delete b[a])}};
function Media(){var d=[],e=[],f=new ImageData,g=new AudioData;this.imageData=function(){return f};this.audioData=function(){return g};this.release=function(){f.release();g.release()};this.load=function(i,l,m){var h=0;d=[];e=[];for(var c in i){var j=c.substr(Math.max(0,c.lastIndexOf("."))),b=function(a,b){d.push({id:a,url:b})},a=function(a,b){e.push({id:a,url:b})},b={".png":b,".jpg":b,".gif":b,".ogg":a,".mp3":a,".mp4":a,".wav":a,".mid":a,".rmi":a,".webm":a}[j.toLowerCase()];if(b!=void 0)b(c,i[c]);
else throw Error("Can't load media '"+c+"': unsupported file format '"+j+"'");h++}var n=0,k=function(a){l({file:a.file,total:h,remaining:h-n++})};f.load(d,k,function(){g.load(e,k,m)})}};
function TableManager(){var e=this,f=0,c={};this.reset=function(){f=0;c={}};this.tableExists=function(a){return c[a]!=void 0};this.createTable=function(){var a="table#"+f++;c[a]={};return a};this.destroyTable=function(a){if(c[a]==void 0)throw Error("Can't destroy table '"+a+"': invalid table!");c[a]=void 0};this.tableSize=function(a){if(c[a]==void 0)throw Error("Can't check the table size of '"+a+"': invalid table!");var b=0,d;for(d in c[a])b++;return b};this.tableEntryExists=function(a,b){if(c[a]==
void 0)throw Error("Can't check if entry '"+b+"' of '"+a+"' exists: invalid table!");return c[a][b]!=void 0};this.removeTableEntry=function(a,b){if(c[a]==void 0)throw Error("Can't remove entry '"+b+"' of '"+a+"': invalid table!");return c[a][b]!=void 0?(c[a][b]=void 0,!0):!1};this.getTableEntry=function(a,b){if(c[a]==void 0)throw Error("Can't get entry '"+b+"' of '"+a+"': invalid table!");return c[a][b]!=void 0?c[a][b]:""};this.setTableEntry=function(a,b,d){if(c[a]==void 0)throw Error("Can't set entry '"+
b+"' of '"+a+"' to '"+d+"': invalid table!");c[a][b]=d};this.cloneTable=function(a){if(c[a]==void 0)throw Error("Can't clone table '"+a+"': invalid table!");var b=e.createTable(),d;for(d in c[a])c[b][d]=c[a][d];return b};this.getTableIterator=function(a){if(c[a]==void 0)throw Error("Can't get iterator to table '"+a+"': invalid table!");var b=[],d;for(d in c[a])b.push(d);return[b,0]};this.tableIteratorIsValid=function(a,b){if(c[a]==void 0)throw Error("Can't check validity of iterator of table '"+a+
"': invalid table!");else if(b.length!=2)throw Error("tableIteratorIsValid: not a table iterator");return b[1]>=0&&b[1]<b[0].length};this.incrementTableIterator=function(a,b){if(!e.tableIteratorIsValid(a,b))throw Error("incrementTableIterator: Invalid table iterator");return[b[0],b[1]+1]};this.getKeyFromTableIterator=function(a,b){if(!e.tableIteratorIsValid(a,b))throw Error("getKeyFromTableIterator: Invalid table iterator");return b[0][b[1]]};this.getValueFromTableIterator=function(a,b){if(!e.tableIteratorIsValid(a,
b))throw Error("getValueFromTableIterator: Invalid table iterator");return c[a][b[0][b[1]]]}};
function DataMemory(c){var a=new RAM(c),d=new Media,b=new TableManager;this.ram=function(){return a};this.media=function(){return d};this.tableManager=function(){return b};this.reset=function(){a.reset();b.reset()}};
function Instruction(b,a,d){for(var c=[b,a,d],b=0;b<c.length;b++)if(a=c[b],typeof a!="number"&&typeof a!="string"&&typeof a!="boolean")throw Error("Invalid machine instruction");else typeof a=="string"&&(a=a.replace(/</g,"&lt;").replace(/>/g,"&gt;"));this.opcode=function(){return c[0]};this.operand1=function(){return c[1]};this.operand2=function(){return c[2]}};
function InstructionMemory(){var b=[];this.reset=function(){b=[]};this.get=function(a){if(a<0||a>=b.length)throw Error("Can't find instruction number "+a);return b[a]};this.push=function(a){b.push(a)}};
function Printer(){}Printer.prototype.print=function(b){var a=$("#printer").text();$("#printer").text((a!=""?a+"\n":a)+(""+b))};Printer.prototype.text=function(){return $("#printer").text()};
function VideoDevice(){var p=this,h=0,k=!1,j=function(){return $("#screen"+(k?1-h:h))[0]},i=function(){return j().getContext("2d")},q=function(){if(!j()||!i())throw Error("Invalid canvas!");};q();j().style.visibility="visible";var g={r:255,g:255,b:255,a:1},m=function(a,c,f,e){g.r=a;g.g=c;g.b=f;g.a=e;for(a=0;a<2;a++)c=i(),f="rgba("+g.r+","+g.g+","+g.b+","+g.a+")",c.fillStyle=f,c.strokeStyle=f,h=1-h};m(g.r,g.g,g.b,g.a);var b={translationX:0,translationY:0,scaleX:1,scaleY:1,rotationAngle:0},n=function(a,
c,f,e,d){b.translationX=parseFloat(a);b.translationY=parseFloat(c);b.scaleX=parseFloat(f);b.scaleY=parseFloat(e);b.rotationAngle=parseFloat(d);for(var a=b.scaleX,c=b.scaleY,f=b.translationX,e=b.translationY,d=Math.cos(b.rotationAngle),g=Math.sin(b.rotationAngle),j=0;j<2;j++)i().setTransform(a*d,c*g,-a*g,c*d,f,e),h=1-h},o=[],l=function(a){o.forEach(function(c){c.notify(p,a)})};this.registerObserver=function(a){a in o||o.push(a)};for(var r=0;r<2;r++)$("#screen"+(k?1-h:h)).mousemove(function(a){l({msg:"mousemove",
xpos:a.pageX-this.offsetLeft,ypos:a.pageY-this.offsetTop})}).mousedown(function(a){l({msg:"mousedown",button:a.which})}).mouseup(function(a){l({msg:"mouseup",button:a.which})}),h=1-h;this.canvasWidth=function(){return j().width};this.canvasHeight=function(){return j().height};this.setColor=function(a,c,f){m(a,c,f,g.a)};this.setAlpha=function(a){m(g.r,g.g,g.b,a)};this.setTranslation=function(a,c){n(a,c,b.scaleX,b.scaleY,b.rotationAngle)};this.setScale=function(a,c){n(b.translationX,b.translationY,
a,c,b.rotationAngle)};this.setRotation=function(a){n(b.translationX,b.translationY,b.scaleX,b.scaleY,a)};this.enableDoubleBuffering=function(){k||(k=!0,q(),l({msg:"enabled double buffering"}))};this.disableDoubleBuffering=function(){if(k)j().style.visibility="hidden",i().clearRect(0,0,this.canvasWidth(),this.canvasHeight()),h=1-h,j().style.visibility="hidden",i().clearRect(0,0,this.canvasWidth(),this.canvasHeight()),k=!1,h=0,j().style.visibility="visible",l({msg:"disabled double buffering"})};this.isDoubleBufferingEnabled=
function(){return k};this.flip=function(){j().style.visibility="visible";h=1-h;j().style.visibility="hidden";l({msg:"flipped"})};this.cls=function(){i().clearRect(0,0,this.canvasWidth(),this.canvasHeight())};this.drawImage=function(a,c,f){i().drawImage(a,c,f)};this.drawScaledImage=function(a,c,f,e,d){i().drawImage(a,c,f,e,d)};this.drawClippedImage=function(a,c,f,e,d,b,g,h,j){i().drawImage(a,c,f,e,d,b,g,h,j)};this.textout=function(a,c,f,e,d){var b=i();b.font=parseInt(c)+"pt "+a;b.textBaseline="top";
b.fillText(d,parseInt(f)-0.5,parseInt(e)-0.5)};this.rectfill=function(a,c,f,b){var d=i();d.beginPath();d.rect(parseInt(a)-0.5,parseInt(c)-0.5,parseInt(f)+0.5,parseInt(b)+0.5);d.closePath();d.fill()};this.rect=function(a,c,b,e){var d=i();d.beginPath();d.rect(parseInt(a)-0.5,parseInt(c)-0.5,parseInt(b)+0.5,parseInt(e)+0.5);d.closePath();d.stroke()};this.circlefill=function(a,c,b){var e=i();e.beginPath();e.arc(parseInt(a)-0.5,parseInt(c)-0.5,parseInt(b)+0.5,0,2*Math.PI,!0);e.closePath();e.fill()};this.circle=
function(a,c,b){var e=i();e.beginPath();e.arc(parseInt(a)-0.5,parseInt(c)-0.5,parseInt(b)+0.5,0,2*Math.PI,!0);e.closePath();e.stroke()};this.line=function(a,b,f,e){var d=i();d.beginPath();d.moveTo(parseInt(a)-0.5,parseInt(b)-0.5);d.lineTo(parseInt(f)-0.5,parseInt(e)-0.5);d.closePath();d.stroke()};this.reset=function(){n(0,0,1,1,0);m(1,1,1,1);p.disableDoubleBuffering();i().clearRect(0,0,this.canvasWidth(),this.canvasHeight())}};
function AudioDevice(){this.play=function(a,b){a!=null&&a.play(b<0?9999999:b)};this.stop=function(a){a!=null&&a.stop()};this.pause=function(a){a!=null&&a.pause()};this.resume=function(a){a!=null&&a.resume()};this.setPosition=function(a,b){a!=null&&a.setPosition(b)};this.getPosition=function(a){return a!=null?a.getPosition():0};this.setVolume=function(a,b){a!=null&&a.setVolume(b)};this.getVolume=function(a){return a!=null?_getVolume(a):0.5};this.getDuration=function(a){return a!=null?a.getDuration():
0};this.isPlaying=function(a){return a!=null?a.isPlaying():!1}};
function Keyboard(b){var c=this;this.baseAddress=function(){return 304};for(var d=0;d<512;d++)b.write(c.baseAddress()+d,!1);$(document).keydown(function(a){a=Math.max(0,Math.min(255,a.which));b.write(c.baseAddress()+a,!0)});$(document).keyup(function(a){a=Math.max(0,Math.min(255,a.which));b.write(c.baseAddress()+a,!1)});this.notify=function(a,d){switch(d.msg){case "flipped":for(var e=0;e<256;e++)b.write(c.baseAddress()+e+256,b.read(c.baseAddress()+e))}}};
function Mouse(b){var c=this;this.baseAddress=function(){return 144};this.notify=function(e,d){switch(d.msg){case "mousemove":b.write(c.baseAddress()+0,d.xpos);b.write(c.baseAddress()+1,d.ypos);break;case "mousedown":var a=Math.min(3,Math.max(1,d.button));b.write(c.baseAddress()+2+(a-1),!0);break;case "mouseup":a=Math.min(3,Math.max(1,d.button));b.write(c.baseAddress()+2+(a-1),!1);break;case "flipped":for(a=0;a<5;a++)b.write(c.baseAddress()+5+a,b.read(c.baseAddress()+a))}}};
function IO(a){var e=new Printer,b=new VideoDevice(a.ram()),f=new AudioDevice(a.ram()),c=new Keyboard(a.ram()),d=new Mouse(a.ram());b.registerObserver(d);b.registerObserver(c);this.printer=function(){return e};this.video=function(){return b};this.audio=function(){return f};this.keyboard=function(){return c};this.mouse=function(){return d}};
function Registers(){var b={PC:0,SP:1,BP:2,CPF:3,ADR:4,FUN:5,A:6,B:7,C:8,D:9},c=Array(10);this.reset=function(){for(var a=0;a<c.length;a++)c[a]=0};this.read=function(a){return c[a]};this.write=function(a,b){return c[a]=b};this.getCode=function(a){if(b[a]==void 0)throw Error("Invalid register name");return b[a]};this.reset()};
function DPU(){function e(){}function c(){}function d(){}e.prototype.lcmp=function(a,b){return(a?1:0)-(b?1:0)};e.prototype.lor=function(a,b){return a||b};e.prototype.land=function(a,b){return a&&b};e.prototype.lxor=function(a,b){return!a&&b||a&&!b};e.prototype.lnot=function(a){return!a};c.prototype.fcmp=function(a,b){return a-b};c.prototype.fadd=function(a,b){return a+b};c.prototype.fsub=function(a,b){return a-b};c.prototype.fmul=function(a,b){return a*b};c.prototype.fdiv=function(a,b){return b==
0?Infinity:a/b};c.prototype.fmod=function(a,b){return a-b*Math.floor(this.fdiv(a,b))};c.prototype.fneg=function(a){return-a};c.prototype.fint=function(a){return Math.floor(a)};c.prototype.facos=function(a){return Math.acos(a)};c.prototype.fasin=function(a){return Math.asin(a)};c.prototype.fatan=function(a){return Math.atan(a)};c.prototype.fceil=function(a){return Math.ceil(a)};c.prototype.fcos=function(a){return Math.cos(a)};c.prototype.fexp=function(a){return Math.exp(a)};c.prototype.ffloor=function(a){return Math.floor(a)};
c.prototype.frnd=function(){return Math.random()};c.prototype.flog=function(a){return a>=0?Math.log(a):0};c.prototype.fsin=function(a){return Math.sin(a)};c.prototype.fsqrt=function(a){return a>=0?Math.sqrt(a):0};c.prototype.ftan=function(a){return Math.cos(a)==0?(Math.sin(a)>=0?1:-1)*Infinity:Math.tan(a)};c.prototype.fpow=function(a,b){return Math.pow(a,b)};d.prototype.scmp=function(a,b){return a==b?0:a<b?-1:1};d.prototype.slen=function(a){return a.length};d.prototype.smid=function(a,b,c){b=Math.min(a.length,
Math.max(b,0));return a.substr(b,b+Math.min(a.length-b,Math.max(c,0)))};d.prototype.scat=function(a,b){return(""+a).concat(""+b)};d.prototype.supr=function(a){return(""+a).toUpperCase()};d.prototype.slwr=function(a){return(""+a).toLowerCase()};d.prototype.sstr=function(a){return""+a};d.prototype.sval=function(a){return parseFloat(a)};d.prototype.sasc=function(a){return(a+" ").charCodeAt(0)};d.prototype.schr=function(a){return String.fromCharCode(parseInt(a))};var f=new e,g=new c,h=new d;this.lu=function(){return f};
this.fpu=function(){return g};this.su=function(){return h}};
function WindowInterrupt(b,e,d,c,a){b=a();switch(b){case 0:alert(a());break;case 1:b=a();a();a=prompt(b);c(a!=null&&a!=void 0?a:"");break;case 2:c(confirm(a())?!0:!1);break;default:throw Error("WindowInterrupt: invalid task: "+b);}}function PrinterInterrupt(b,e,d,c,a){e=a();switch(e){case 0:b.printer().print(a());break;default:throw Error("PrinterInterrupt: invalid task: "+e);}}
function AudioInterrupt(b,e,d,c,a){d=a();switch(d){case 0:c(e.audioData().createVoice(a()));break;case 1:e.audioData().destroyVoice(a());break;case 2:c=a();a=a();b.audio().play(e.audioData().getVoice(c),a);break;case 3:b.audio().stop(e.audioData().getVoice(a()));break;case 4:b.audio().pause(e.audioData().getVoice(a()));break;case 5:b.audio().resume(e.audioData().getVoice(a()));break;case 6:c=a();a=a();b.audio().setPosition(e.audioData().getVoice(c),a);break;case 7:c(b.audio().getPosition(e.audioData().getVoice(a())));
break;case 8:c=a();a=a();b.audio().setVolume(e.audioData().getVoice(c),a);break;case 9:c(b.audio().getVolume(e.audioData().getVoice(a())));break;case 10:c(b.audio().getDuration(e.audioData().getVoice(a())));break;case 11:c(b.audio().isPlaying(e.audioData().getVoice(a())));break;default:throw Error("AudioInterrupt: invalid task: "+d);}}
function VideoInterrupt(b,e,d,c,a){d=a();switch(d){case 0:c(b.video().canvasWidth());break;case 1:c(b.video().canvasHeight());break;case 2:break;case 3:break;case 4:b.video().enableDoubleBuffering();break;case 5:b.video().flip();break;case 6:b.video().cls();break;case 10:e=a();c=a();a=a();b.video().setColor(e,c,a);break;case 11:b.video().setAlpha(a());break;case 12:var c=a(),d=a(),f=a(),a=a();b.video().rectfill(c,d,f,a);break;case 13:c=a();d=a();f=a();a=a();b.video().rect(c,d,f,a);break;case 14:c=
a();d=a();e=a();b.video().circlefill(c,d,e);break;case 15:c=a();d=a();e=a();b.video().circle(c,d,e);break;case 16:c=a();d=a();e=a();a=a();b.video().line(c,d,e,a);break;case 17:e=a();f=a();c=a();d=a();a=a();b.video().textout(e,f,c,d,a);break;case 18:var g=a(),c=a(),d=a();b.video().drawImage(e.imageData().get(g),c,d);break;case 19:g=a();c=a();d=a();f=a();a=a();b.video().drawScaledImage(e.imageData().get(g),c,d,f,a);break;case 20:var g=a(),h=a(),i=a(),j=a(),k=a(),c=a(),d=a(),f=a(),a=a();b.video().drawClippedImage(e.imageData().get(g),
h,i,j,k,c,d,f,a);break;case 21:c(e.imageData().get(a()).width);break;case 22:c(e.imageData().get(a()).height);break;case 23:c=a();a=a();b.video().setTranslation(c,a);break;case 24:c=a();a=a();b.video().setScale(c,a);break;case 25:a=a();b.video().setRotation(a);break;default:throw Error("VideoInterrupt: invalid task: "+d);}}function MouseInterrupt(b,e,d,c,a){b=a();switch(b){default:throw Error("MouseInterrupt: invalid task: "+b);}}
function KeyboardInterrupt(b,e,d,c,a){b=a();switch(b){default:throw Error("KeyboardInterrupt: invalid task: "+b);}}
function MemoryInterrupt(b,e,d,c,a){b=a();switch(b){case 0:b=a();c(d.tableExists(b));break;case 1:c(d.createTable());break;case 2:b=a();d.destroyTable(b);break;case 3:b=a();c(d.tableSize(b));break;case 4:b=a();e=a();c(d.tableEntryExists(b,e));break;case 5:b=a();e=a();c(d.removeTableEntry(b,e));break;case 6:b=a();e=a();c(d.getTableEntry(b,e));break;case 7:b=a();e=a();c=a();d.setTableEntry(b,e,c);break;case 8:b=a();c(d.cloneTable(b));break;case 9:b=a();c(d.getTableIterator(b));break;case 10:b=a();a=
a();c(d.tableIteratorIsValid(b,a));break;case 11:b=a();a=a();c(d.incrementTableIterator(b,a));break;case 12:b=a();a=a();c(d.getKeyFromTableIterator(b,a));break;case 13:b=a();a=a();c(d.getValueFromTableIterator(b,a));break;default:throw Error("MemoryInterrupt: invalid task: "+b);}}
function InterruptionManager(b,e,d){var c={3:MemoryInterrupt,4:WindowInterrupt,5:PrinterInterrupt,6:AudioInterrupt,7:VideoInterrupt,8:KeyboardInterrupt,9:MouseInterrupt},a=d.ram(),f=b.getCode("SP"),g=function(){return a.read(b.write(f,b.read(f)+1))},h=function(c){return a.write(1+b.write(f,b.read(f)-1),c)};this.run=function(a){if(typeof c[a]=="function")c[a](e,d.media(),d.tableManager(),h,g);else throw Error("Invalid interruption code: "+a);}};
function ControlUnit(k,f,r,s,l){var b={NOP:0,HALT:1,MOVC:2,MOVR:3,LOADC:4,LOADR:5,STOREC:6,STORER:7,JMPC:8,JMPR:9,LCMPC:10,LCMPR:11,FCMPC:12,FCMPR:13,SCMPC:14,SCMPR:15,JEC:16,JNEC:17,JLC:18,JLEC:19,JGC:20,JGEC:21,JER:22,JNER:23,JLR:24,JLER:25,JGR:26,JGER:27,PUSHC:28,PUSHR:29,POP:30,CALLC:31,CALLR:32,RET:33,INTC:34,INTR:35,LORC:36,LORR:37,LANDC:38,LANDR:39,LXORC:40,LXORR:41,LNOT:42,FADDC:43,FADDR:44,FSUBC:45,FSUBR:46,FMULC:47,FMULR:48,FDIVC:49,FDIVR:50,FMODC:51,FMODR:52,FNEG:53,FINT:54,FACOS:55,FASIN:56,
FATAN:57,FCEIL:58,FCOS:59,FEXP:60,FFLOOR:61,FRND:62,FLOG:63,FSIN:64,FSQRT:65,FTAN:66,SLEN:67,SLEFTC:68,SLEFTR:69,SRIGHTC:70,SRIGHTR:71,SCATC:72,SCATR:73,SUPR:74,SLWR:75,SSTR:76,SVAL:77,FPOWC:78,FPOWR:79,TYPE:80,SASC:81,SCHR:82,$:void 0},i=k.getCode("SP"),m=k.getCode("BP"),j=k.getCode("PC"),h=k.getCode("CPF"),c=k.read,e=k.write,p=l.ram().read,n=l.ram().write,t=s.get,o=!1,q=new InterruptionManager(k,r,l),d={};d[b.NOP]=function(){};d[b.HALT]=function(){o=!0};d[b.MOVC]=function(a,b){e(a,b)};d[b.MOVR]=
function(a,b){e(a,c(b))};d[b.LOADC]=function(a,b){e(a,p(b))};d[b.LOADR]=function(a,b){e(a,p(c(b)))};d[b.STOREC]=function(a,b){n(b,c(a))};d[b.STORER]=function(a,b){n(c(b),c(a))};d[b.LCMPC]=function(a,b){e(h,f.lu().lcmp(c(a),b))};d[b.LCMPR]=function(a,b){e(h,f.lu().lcmp(c(a),c(b)))};d[b.FCMPC]=function(a,b){e(h,f.fpu().fcmp(c(a),b))};d[b.FCMPR]=function(a,b){e(h,f.fpu().fcmp(c(a),c(b)))};d[b.SCMPC]=function(a,b){e(h,f.su().scmp(c(a),b))};d[b.SCMPR]=function(a,b){e(h,f.su().scmp(c(a),c(b)))};d[b.JMPC]=
function(a){e(j,a)};d[b.JMPR]=function(a){e(j,c(a))};d[b.JEC]=function(a,g){d[b[c(h)==0?"JMPC":"NOP"]](a,g)};d[b.JNEC]=function(a,g){d[b[c(h)!=0?"JMPC":"NOP"]](a,g)};d[b.JLC]=function(a,g){d[b[c(h)<0?"JMPC":"NOP"]](a,g)};d[b.JLEC]=function(a,g){d[b[c(h)<=0?"JMPC":"NOP"]](a,g)};d[b.JGC]=function(a,g){d[b[c(h)>0?"JMPC":"NOP"]](a,g)};d[b.JGEC]=function(a,g){d[b[c(h)>=0?"JMPC":"NOP"]](a,g)};d[b.JER]=function(a,g){d[b[c(h)==0?"JMPR":"NOP"]](a,g)};d[b.JNER]=function(a,g){d[b[c(h)!=0?"JMPR":"NOP"]](a,g)};
d[b.JLR]=function(a,g){d[b[c(h)<0?"JMPR":"NOP"]](a,g)};d[b.JLER]=function(a,g){d[b[c(h)<=0?"JMPR":"NOP"]](a,g)};d[b.JGR]=function(a,g){d[b[c(h)>0?"JMPR":"NOP"]](a,g)};d[b.JGER]=function(a,g){d[b[c(h)>=0?"JMPR":"NOP"]](a,g)};d[b.PUSHC]=function(a){n(1+e(i,c(i)-1),a);if(c(i)>c(m))throw Error("Stack overflow");};d[b.PUSHR]=function(a){n(1+e(i,c(i)-1),c(a));if(c(i)>c(m))throw Error("Stack overflow");};d[b.POP]=function(a){e(a,p(e(i,c(i)+1)));if(c(i)>c(m))throw Error("Stack overflow");};d[b.CALLC]=function(a){d[b.PUSHR](j,
0);d[b.JMPC](a,0)};d[b.CALLR]=function(a){d[b.PUSHR](j,0);d[b.JMPR](a,0)};d[b.RET]=function(){d[b.POP](j,0)};d[b.INTC]=function(a){q.run(a)};d[b.INTR]=function(a){q.run(c(a))};d[b.LORC]=function(a,b){e(a,f.lu().lor(c(a),b))};d[b.LORR]=function(a,b){e(a,f.lu().lor(c(a),c(b)))};d[b.LANDC]=function(a,b){e(a,f.lu().land(c(a),b))};d[b.LANDR]=function(a,b){e(a,f.lu().land(c(a),c(b)))};d[b.LXORC]=function(a,b){e(a,f.lu().lxor(c(a),b))};d[b.LXORR]=function(a,b){e(a,f.lu().lxor(c(a),c(b)))};d[b.LNOT]=function(a){e(a,
f.lu().lnot(c(a)))};d[b.FADDC]=function(a,b){e(a,f.fpu().fadd(c(a),b))};d[b.FADDR]=function(a,b){e(a,f.fpu().fadd(c(a),c(b)))};d[b.FSUBC]=function(a,b){e(a,f.fpu().fsub(c(a),b))};d[b.FSUBR]=function(a,b){e(a,f.fpu().fsub(c(a),c(b)))};d[b.FMULC]=function(a,b){e(a,f.fpu().fmul(c(a),b))};d[b.FMULR]=function(a,b){e(a,f.fpu().fmul(c(a),c(b)))};d[b.FDIVC]=function(a,b){e(a,f.fpu().fdiv(c(a),b))};d[b.FDIVR]=function(a,b){e(a,f.fpu().fdiv(c(a),c(b)))};d[b.FMODC]=function(a,b){e(a,f.fpu().fmod(c(a),b))};d[b.FMODR]=
function(a,b){e(a,f.fpu().fmod(c(a),c(b)))};d[b.FNEG]=function(a){e(a,f.fpu().fneg(c(a)))};d[b.FINT]=function(a){e(a,f.fpu().fint(c(a)))};d[b.FACOS]=function(a){e(a,f.fpu().facos(c(a)))};d[b.FASIN]=function(a){e(a,f.fpu().fasin(c(a)))};d[b.FATAN]=function(a){e(a,f.fpu().fatan(c(a)))};d[b.FCEIL]=function(a){e(a,f.fpu().fceil(c(a)))};d[b.FCOS]=function(a){e(a,f.fpu().fcos(c(a)))};d[b.FEXP]=function(a){e(a,f.fpu().fexp(c(a)))};d[b.FFLOOR]=function(a){e(a,f.fpu().ffloor(c(a)))};d[b.FRND]=function(a){e(a,
f.fpu().frnd())};d[b.FLOG]=function(a){e(a,f.fpu().flog(c(a)))};d[b.FSIN]=function(a){e(a,f.fpu().fsin(c(a)))};d[b.FSQRT]=function(a){e(a,f.fpu().fsqrt(c(a)))};d[b.FTAN]=function(a){e(a,f.fpu().ftan(c(a)))};d[b.SLEN]=function(a){e(a,f.su().slen(c(a)))};d[b.SLEFTC]=function(a,b){e(a,f.su().mid(c(a),0,b))};d[b.SLEFTR]=function(a,b){e(a,f.su().mid(c(a),0,c(b)))};d[b.SRIGHTC]=function(a,b){e(a,f.su().mid(c(a),c(a).length-b,b))};d[b.SRIGHTR]=function(a,b){e(a,f.su().mid(c(a),c(a).length-c(b),c(b)))};d[b.SCATC]=
function(a,b){e(a,f.su().scat(c(a),b))};d[b.SCATR]=function(a,b){e(a,f.su().scat(c(a),c(b)))};d[b.SUPR]=function(a){e(a,f.su().supr(c(a)))};d[b.SLWR]=function(a){e(a,f.su().slwr(c(a)))};d[b.SSTR]=function(a){e(a,f.su().sstr(c(a)))};d[b.SVAL]=function(a){e(a,f.su().sval(c(a)))};d[b.FPOWC]=function(a,b){e(a,f.fpu().fpow(c(a),b))};d[b.FPOWR]=function(a,b){e(a,f.fpu().fpow(c(a),c(b)))};d[b.TYPE]=function(a){e(a,(typeof c(a)).toLowerCase())};d[b.SASC]=function(a){e(a,f.su().sasc(c(a)))};d[b.SCHR]=function(a){e(a,
f.su().schr(c(a)))};this.reset=function(){o=!1;e(i,l.ram().capacity()-1);e(m,l.ram().capacity()-1);e(j,0)};this.programHasTerminated=function(){return o};this.getOpcode=function(a){if(typeof a!="string"||b[a]==void 0)throw Error("Illegal instruction");return b[a]};this.fetchDecodeExecute=function(){if(!o){var a=t(c(j)),b=d[a.opcode()];e(j,c(j)+1);b(a.operand1(),a.operand2())}};this.reset()};
function Clock(b,c,i,j){if(typeof b!="number"||b<=0)throw Error("Clock error: invalid value for cycles per second");else if(typeof c!="number"||c<=0)throw Error("Clock error: invalid value for instructions per cycle");else if(typeof i!="function")throw Error("Clock error: invalid callback");var k=this,d=0,a=null,f=0,g=!1,e=!1,h=function(){try{for(var a=0;(e&&!g||!e)&&a<c;a++)i(),++d;g=!1}catch(b){k.stop(),alert("FATAL ERROR:\n\n"+b.message)}};this.getCyclesPerSecond=function(){return b};this.getInstructionsPerCycle=
function(){return c};this.ticks=function(){return d};this.start=function(){a==null&&(f=(new Date).getTime(),a=window.setInterval(h,Math.ceil(1E3/b)))};this.stop=function(){a!=null&&(window.clearInterval(a),a=null,d=f=0)};this.notify=function(c,d){switch(d.msg){case "enabled double buffering":a!=null&&(window.clearInterval(a),a=null);e=!0;a=window.setInterval(h,Math.ceil(1E3/60));break;case "disabled double buffering":a!=null&&(window.clearInterval(a),a=null);e=!1;a=window.setInterval(h,Math.ceil(1E3/
b));break;case "flipped":g=!0}};j!=null&&window.setInterval(function(){a!=null&&j.write(288,(new Date).getTime()-f)},10)};
function CPU(i,j,c,g,d){var h=new DPU,e=new Registers,f=new ControlUnit(e,h,c,g,d),a=new Clock(i,j,f.fetchDecodeExecute,d.ram());c.video().registerObserver(a);this.dpu=function(){return h};this.registers=function(){return e};this.controlUnit=function(){return f};this.clock=function(){return a};var b=!1;this.powerOn=function(){b||(a.start(),b=!0)};this.powerOff=function(){b&&(c.video().reset(),a.stop(),e.reset(),f.reset(),g.reset(),d.reset(),b=!1)}};
function RuntimeEngine(l,m,n){var g=new LoadingScreen,h=!1,e=null,d=null,i=null,b=null;this.loadGame=function(f,o){var c=[],j="Noname",k={};if(!h){h=!0;b!=null&&b.powerOff();b=i=d=e=null;if(f==void 0)throw Error("Invalid game");c=f.program;j=f.title;k=f.media;if(c==void 0)throw Error("No program given");else if(c.length%3!=0)throw Error("Invalid program length");document.title=j;e=new InstructionMemory;d=new DataMemory(n);d.media().load(k,function(a){g.display(a.file,1-a.remaining/a.total)},function(){g.display("",
1);for(var a=0;a<c.length;a+=3)e.push(new Instruction(c[a+0],c[a+1],c[a+2]));e.push(new Instruction(1,0,0));i=new IO(d);b=new CPU(l,m,i,e,d);setTimeout(function(){g.clear();h=!1;o()},1E3)})}};this.powerOn=function(){if(b!=null)b.powerOn();else throw Error("Please load the program");};this.powerOff=function(){b!=null&&(b.powerOff(),d.media().release())}};
